<% layout('layout/boilerplate.ejs') %>

<div class="container my-5">
  <div class="row mb-4">
    <div class="col">
      <h1 class="display-5 fw-bold">
        <i class="fas fa-bullseye me-2 mt-5"></i>My Goals
      </h1>
      <p class="lead text-muted">Track progress across all your environmental goals</p>
      <a href="/goals/set-goals" class="btn btn-primary mt-3">
        <i class="fas fa-plus me-2"></i>Set New Goal
      </a>
  </div>
</div>

<script>
// Enhanced Dynamic Days Remaining Update for All Goals
document.addEventListener('DOMContentLoaded', function() {
    const goalCards = document.querySelectorAll('.col-lg-6[data-end-date]');

    goalCards.forEach(card => {
        const endDateStr = card.getAttribute('data-end-date');
        const timeframeEnded = card.getAttribute('data-timeframe-ended') === 'true';
        const endDate = new Date(endDateStr);

        // Find the days remaining value span
        const daysSpan = card.querySelector('.days-remaining-value');
        const statusElement = card.querySelector('p strong');
        const badgeElement = card.querySelector('.badge');

        function updateDaysRemaining() {
            const now = new Date();
            const timeDiff = endDate - now;
            const daysRemaining = Math.max(0, Math.ceil(timeDiff / (1000 * 60 * 60 * 24)));

            // Update days remaining value if the span exists
            if (daysSpan) {
                daysSpan.textContent = daysRemaining;
            }

            // Update status text and badge if timeframe has changed
            if (statusElement && badgeElement) {
                if (daysRemaining === 0 && !timeframeEnded) {
                    // Goal ends today
                    statusElement.innerHTML = '<strong>Status:</strong> <span class="text-warning">Ends Today</span>';
                    badgeElement.textContent = 'Ends Today';
                    badgeElement.className = 'badge bg-warning';
                } else if (daysRemaining < 0 && !timeframeEnded) {
                    // Goal has expired
                    statusElement.innerHTML = '<strong>Status:</strong> <span class="text-danger">Expired</span>';
                    badgeElement.textContent = 'Expired';
                    badgeElement.className = 'badge bg-danger';
                }
            }
        }

        // Update immediately and then every minute
        updateDaysRemaining();
        setInterval(updateDaysRemaining, 60000); // Update every 60 seconds
    });

    // Add visual feedback for time-sensitive goals
    const activeGoals = document.querySelectorAll('.col-lg-6[data-timeframe-ended="false"]');
    activeGoals.forEach(card => {
        const daysSpan = card.querySelector('.days-remaining-value');
        if (daysSpan) {
            const days = parseInt(daysSpan.textContent);
            if (days <= 3) {
                daysSpan.classList.add('text-warning', 'fw-bold');
            }
            if (days <= 1) {
                daysSpan.classList.remove('text-warning');
                daysSpan.classList.add('text-danger', 'fw-bold');
            }
        }
    });
});
</script>

  <div class="row g-4">
    <% if (goals.length === 0) { %>
      <div class="col-12">
        <div class="alert alert-info">
          You have no goals yet. Click "Set New Goal" to start tracking your progress.
        </div>
      </div>
    <% } %>

    <% goals.forEach(goal => { %>
      <div class="col-lg-6" data-end-date="<%= goal.endDate %>" data-timeframe-ended="<%= goal.timeframeEnded %>">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0 text-success"><i class="fas fa-bullseye me-2"></i><%= goal.title %></h5>
              <span class="badge <%= goal.statusBadgeClass %>"><%= goal.statusText %></span>
            </div>

            <p class="mb-2">
              <strong>Emissions Limit:</strong> <%= goal.reductionTarget %> kg CO₂<br>
              <strong>Timeframe:</strong> <%= goal.timeframe %>
            </p>

            <!-- Progress Bar -->
            <div class="progress mb-2" style="height: 25px;">
              <div 
                class="progress-bar <%= goal.goalReached ? 'bg-success' : 'bg-warning' %>" 
                role="progressbar" 
                style="width: <%= goal.progress %>%" 
                aria-valuenow="<%= goal.progress %>" 
                aria-valuemin="0" 
                aria-valuemax="100">
                <%= goal.progress %>% 
              </div>
            </div>

            <p class="mb-2">
              <strong>Current CO₂:</strong> <%= goal.totalCO2.toFixed(2) %> kg<br>
              <strong>Budget Remaining:</strong> <%= Math.max(0, goal.reductionTarget - goal.totalCO2).toFixed(2) %> kg<br>
              <strong>Start:</strong> <%= new Date(goal.startDate).toLocaleDateString() %><br>
              <strong>End:</strong> <%= new Date(goal.endDate).toLocaleDateString() %>
            </p>

            <% if (goal.isActive) { %>
              <p><strong>Days Remaining:</strong> <span class="days-remaining-value"><%= goal.daysRemaining %></span> days</p>
            <% } else if (goal.isEndingToday) { %>
              <p><strong>Status:</strong> <span class="text-warning">Ends Today</span></p>
            <% } else if (goal.isExpired) { %>
              <p><strong>Status:</strong> <span class="text-danger">Expired</span></p>
            <% } %>

            <div class="d-flex gap-2 mt-2">
              <a href="/goals/<%= goal._id %>" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-eye me-1"></i>View
              </a>
              <a href="/goals/edit-goal/<%= goal._id %>" class="btn btn-outline-success btn-sm">
                <i class="fas fa-edit me-1"></i>Edit
              </a>
              <form action="/goals/<%= goal._id %>?_method=delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this goal?')" class="d-inline">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>