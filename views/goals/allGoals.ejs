<% layout('layout/boilerplate.ejs') %>

<div class="container my-5">
  <div class="row mb-4">
    <div class="col">
      <h1 class="display-5 fw-bold">
        <i class="fas fa-bullseye me-2 mt-5"></i>My Goals
      </h1>
      <p class="lead text-muted">Track progress across all your environmental goals</p>
      <a href="/goals/set-goals" class="btn btn-primary mt-3">
        <i class="fas fa-plus me-2"></i>Set New Goal
      </a>
    </div>
  </div>

  <div class="row g-4">
    <% if (goals.length === 0) { %>
      <div class="col-12">
        <div class="alert alert-info">
          You have no goals yet. Click "Set New Goal" to start tracking your progress.
        </div>
      </div>
    <% } %>

    <% goals.forEach(goal => { %>
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0 text-success"><i class="fas fa-bullseye me-2"></i><%= goal.title %></h5>
              <% if (goal.goalReached) { %>
                <span class="badge bg-success">Achieved</span>
              <% } else if (goal.timeframeEnded) { %>
                <span class="badge bg-danger">Expired</span>
              <% } else { %>
                <span class="badge bg-info">Ongoing</span>
              <% } %>
            </div>

            <p class="mb-2">
              <strong>Emissions Limit:</strong> <%= goal.reductionTarget %> kg CO₂<br>
              <strong>Timeframe:</strong> <%= goal.timeframe %>
            </p>

            <!-- Progress Bar -->
            <div class="progress mb-2" style="height: 25px;">
              <div 
                class="progress-bar <%= goal.goalReached ? 'bg-success' : 'bg-warning' %>" 
                role="progressbar" 
                style="width: <%= goal.progress %>%" 
                aria-valuenow="<%= goal.progress %>" 
                aria-valuemin="0" 
                aria-valuemax="100">
                <%= goal.progress %>% 
              </div>
            </div>

            <p class="mb-2">
              <strong>Current CO₂:</strong> <%= goal.totalCO2.toFixed(2) %> kg<br>
              <strong>Budget Remaining:</strong> <%= Math.max(0, goal.reductionTarget - goal.totalCO2).toFixed(2) %> kg<br>
              <strong>Start:</strong> <%= new Date(goal.startDate).toLocaleDateString() %><br>
              <strong>End:</strong> <%= new Date(goal.endDate).toLocaleDateString() %>
            </p>

            <% const daysRemaining = Math.max(0, Math.ceil((new Date(goal.endDate) - new Date()) / (1000*60*60*24))); %>
            <% if (!goal.timeframeEnded) { %>
              <p><strong>Days Remaining:</strong> <%= daysRemaining %> days</p>
            <% } %>

            <div class="d-flex gap-2 mt-2">
              <a href="/goals/<%= goal._id %>" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-eye me-1"></i>View
              </a>
              <a href="/goals/edit-goal/<%= goal._id %>" class="btn btn-outline-success btn-sm">
                <i class="fas fa-edit me-1"></i>Edit
              </a>
              <form action="/goals/<%= goal._id %>?_method=delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this goal?')" class="d-inline">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>